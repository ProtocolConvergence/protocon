
default:

CC = gcc
CXX = g++
#CC = icc
#CXX = icpc
#CC = clang
#CXX = clang++
#CC = $(CXX)
MPICXX = mpicxx
LEG = leg

CONFIG += ansi
#CONFIG += errwarn
CONFIG += debug
CONFIG += snappy
#CONFIG += profile
#CONFIG += ultradebug
#CONFIG += fast
#CONFIG += noassert
CONFIG += openmp
CONFIG += mpi
CONFIG += gui
#CONFIG += on-gilbert-cluster

DEPENDFILE = $(PfxBldPath)/deps.mk

CxPath = ../cx
BinPath = ../bin
BldPath = protocon

ExeList = protocon satsyn

ifneq (,$(filter on-gilbert-cluster,$(CONFIG)))
	CONFIG := $(filter-out ansi openmp gui,$(CONFIG))
	MPICXX := $(MPICXX) -CC=g++ -I/usr/local/mpi/include -L/usr/local/mpi/lib64
endif
ifneq (,$(filter mpi,$(CONFIG)))
	ExeList += protocon-mpi
endif
ifneq (,$(filter gui,$(CONFIG)))
	ExeList += protocon-gui
endif
ExeList := $(addprefix $(BinPath)/,$(ExeList))

BldPathList = $(PfxBldPath)/protocon/satsyn

include $(CxPath)/include.mk

QMAKE = $(call FindCmd,qmake-qt4 qmake)

CXXBldPath = $(PfxBldPath)/protocon-cxx

GluPath = ../glu-2.4
GluIncludePath = $(GluPath)/include
MinisatIncludePath = /usr/include/minisat2

#CFLAGS += -I$(GluIncludePath)
CXXFLAGS += $(CFLAGS)
LXXFLAGS += -L$(GluPath) -lcu -lglu -lcal -lm

-include $(DEPENDFILE)


default: $(ExeList) udp deadfree biring

all:
	$(MAKE) depend
	$(MAKE)

ProtoconObj = \
	$(addprefix $(BldPath)/, pfmla.o pfmla-glu.o pfmla-bittable.o) \
	$(addprefix $(BldPathCXX)/, pfmla.o xnsys.o xnspec.o inst.o) \
	$(addprefix $(BldPathCXX)/, opt.o stabilization.o) \
	$(addprefix $(BldPathCXX)/, promela.o pla.o graphviz.o) \
	$(addprefix $(BldPathCXX)/, conflictfamily.o) \
	$(addprefix $(BldPathCXX)/, search.o synthesis.o) \
	$(addprefix $(BldPathCXX)/, protoconfile.o protoconfile.leg.o) \
	$(addprefix $(BldPathCXX)/, interactive.o) \
	$(CxStdObjs) $(addprefix $(CxBldPath)/, bstree.o sesp.o rbtree.o ospc.o)

$(BinPath)/protocon: \
	$(ProtoconObj) \
	$(addprefix $(BldPathCXX)/, main.o test.o)
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LXXFLAGS)

$(BinPath)/protocon-mpi: \
	$(ProtoconObj) \
	$(addprefix $(BldPathCXX)/, main-mpi.o mpidissem.o mpidissemnet.o)
	$(MPICXX) $(CXXFLAGS) $^ -o $@ $(LXXFLAGS)

$(call binexe,satsyn): $(BldPath)/satsyn/satsyn.o $(BldPath)/satsyn/xnsys.o \
	$(CxStdObjs) $(addprefix $(CxBldPath)/, bstree.o ospc.o rbtree.o)
	$(CC) $(CFLAGS) -o $@ $^

$(BldPath)/pfmla-glu.o: $(BldPath)/pfmla-glu.c
	$(CC) -c $(CFLAGS) -I$(GluIncludePath) $< -o $@

#$(BldPath)/pfmla-genepi.o: $(BldPath)/pfmla-genepi.c
#	$(CC) -c $(CFLAGS) $< -o $@

$(BldPathCXX)/pfmla-minisat.o: $(BldPathCXX)/pfmla-minisat.cc
	$(CXX) -c $(CXXFLAGS) -isystem $(MinisatIncludePath) $< -o $@

$(BldPathCXX)/main-mpi.o: $(BldPathCXX)/main-mpi.cc
	$(MPICXX) -c $(CXXFLAGS) $< -o $@

$(BldPathCXX)/mpidissem.o: $(BldPathCXX)/mpidissem.cc $(BldPathCXX)/mpidissem.hh
	$(MPICXX) -c $(CXXFLAGS) $< -o $@

$(BldPathCXX)/mpidissemnet.o: $(BldPathCXX)/mpidissemnet.cc $(BldPathCXX)/mpidissemnet.hh
	$(MPICXX) -c $(CXXFLAGS) $< -o $@

$(BldPath)/udp.o: $(BldPath)/udp.c
	$(CC) -c $(filter-out -pedantic,$(CFLAGS)) -D_POSIX_C_SOURCE=199309L -D_BSD_SOURCE $< -o $@

udp: $(BldPath)/udp.o
	$(CC) $(filter-out -pedantic,$(CFLAGS)) -D_POSIX_C_SOURCE=199309L -D_BSD_SOURCE $< -o $@ -lrt

#deadfree: $(BldPathCXX)/deadfree.o $(BldPath)/pfmla-genepi.o $(ProtoconObj)
#	$(CXX) $(CXXFLAGS) $^ -o $@ $(LXXFLAGS) -lgenepi

deadfree: $(BldPathCXX)/deadfree.o $(ProtoconObj)
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LXXFLAGS)

$(BldPathCXX)/biring.o: $(BldPathCXX)/biring.cc
	$(CC) -c $(CFLAGS) -isystem bliss $< -o $@

biring: $(BldPathCXX)/biring.o $(CxObjs)
	#$(CXX) $(CXXFLAGS) $^ -o $@ -Lbliss -lbliss -lm
	$(CXX) $(CXXFLAGS) $^ -o $@ -lm

$(BldPathCXX)/protoconfile.leg.cc: protoconfile.leg
	$(LEG) -o $@ $<

$(BinPath)/protocon-gui: gui/gui
	cp $< $@

.PHONY: gui/gui
gui/gui: gui/Makefile
	$(MAKE) -C gui

gui/Makefile:
	cd gui && $(QMAKE)

#$(CXX) -c $(filter-out -pedantic -Wall -Wextra,$(CXXFLAGS))

.PHONY: depend
depend:
	mkdir -p bld
	grep '^#include *"' *.cc *.hh *.c *.h \
		| grep -v -e 'mdd\.h' -e 'cx/' \
		| sed -e 's/\(.*\):#include.*"\(.*\)".*/\1: \2/' \
		-e 's:\(.*\.\)\(cc\|hh\)\::$(BldPathCXX)\/\1\2\::' \
		-e 's:\(.*\.\)\(c\|h\)\::$(BldPath)\/\1\2\::' \
		-e 's:\: \(.*\.\)\(cc\|hh\)$$:\: $(BldPathCXX)/\1\2:' \
		-e 's:\: \(.*\.\)\(c\|h\)$$:\: $(BldPath)/\1\2:' \
		> $(DEPENDFILE)
	grep '^#include *"' satsyn/*.c satsyn/*.h \
		| grep -v -e 'mdd\.h' -e 'cx/' \
		| sed -e 's/\(.*\):#include.*"\(.*\)".*/\1: \2/' \
		-e 's:\(.*\.\)\(c\|h\)\::$(BldPath)\/\1\2\::' \
		-e 's:\: \(.*\.\)\(c\|h\)$$:\: $(BldPath)\/satsyn/\1\2:' \
		>> $(DEPENDFILE)
	sed -i -e 's/\(.*\)\.\(cc\?\):\(.*\)\.\(hh\?\)/\1.\2:\3.\4\n\1.o:\3.\4/' $(DEPENDFILE)


$(BldPathCXX)/protoconfile.leg.cc: $(BldPathCXX)/protoconfile.hh

.PHONY: clean
clean:
	rm -fr $(PfxBldPath)
	rm -f $(ExeList) udp deadfree
	if [ -f gui/Makefile ] ; then $(MAKE) -C gui distclean ; fi

