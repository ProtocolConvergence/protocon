
default: all

CC = gcc
CXX = g++
#CC = clang
#CXX = clang++
#CC = $(CXX)

CONFIG += ansi
#CONFIG += errwarn
CONFIG += debug
#CONFIG += snappy
#CONFIG += profile
#CONFIG += ultradebug
#CONFIG += fast
#CONFIG += noassert
CONFIG += openmp

CxPath = ../cx
BinPath = ../bin
BldPath = protocon

ExeList = protocon satsyn
ExeList := $(addprefix $(BinPath)/,$(ExeList))

include $(CxPath)/include.mk

CXXBldPath = $(PfxBldPath)/protocon-cxx

GluPath = ../glu-2.4
GluIncludePath = $(GluPath)/include
MinisatIncludePath = /usr/include/minisat2

#CFLAGS += -I$(GluIncludePath)
CXXFLAGS += $(CFLAGS)
LXXFLAGS += -L$(GluPath) -lcu -lglu -lcal -lm

-include deps.mk


all: $(ExeList)

$(BinPath)/protocon: \
	$(addprefix $(BldPath)/, pfmla.o pfmla-glu.o pfmla-bittable.o) \
	$(addprefix $(BldPathCXX)/, pfmla.o xnsys.o test.o inst.o) \
	$(addprefix $(BldPathCXX)/, promela.o pla.o) \
	$(addprefix $(BldPathCXX)/, conflictfamily.o) \
	$(addprefix $(BldPathCXX)/, ordersyn.o main.o stability.o) \
	$(addprefix $(BldPathCXX)/, protoconfile.o protoconfile.leg.o) \
	$(CxStdObjs) $(addprefix $(CxBldPath)/, bstree.o sesp.o rbtree.o ospc.o)
	$(CXX) $(CXXFLAGS) $^ -o $@ $(LXXFLAGS)

$(call binexe,satsyn): $(BldPath)/satsyn.o $(BldPath)/xnsys.o \
	$(CxStdObjs) $(addprefix $(CxBldPath)/, bstree.o ospc.o rbtree.o)
	$(CC) $(CFLAGS) -o $@ $^

$(BldPath)/pfmla-glu.o: $(BldPath)/pfmla-glu.c
	$(CC) -c $(CFLAGS) -I$(GluIncludePath) $< -o $@

$(BldPathCXX)/pfmla-minisat.o: $(BldPathCXX)/pfmla-minisat.cc
	$(CXX) -c $(CXXFLAGS) -isystem $(MinisatIncludePath) $< -o $@

$(BldPathCXX)/protoconfile.leg.cc: protoconfile.leg
	leg -o $@ $<

#$(CXX) -c $(filter-out -pedantic -Wall -Wextra,$(CXXFLAGS))

.PHONY: depend
depend: deps.mk

$(BldPathCXX)/protoconfile.leg.cc: $(BldPathCXX)/protoconfile.hh

deps.mk:
	grep '^#include *"' *.cc *.hh *.c *.h \
		| grep -v -e 'mdd\.h' -e 'cx/' \
		| sed -e 's/\(.*\):#include.*"\(.*\)".*/\1: \2/' \
		-e 's:\(.*\.\)\(cc\|hh\)\::$(BldPathCXX)\/\1\2\::' \
		-e 's:\(.*\.\)\(c\|h\)\::$(BldPath)\/\1\2\::' \
		-e 's:\: \(.*\.\)\(cc\|hh\)$$:\: $(BldPathCXX)/\1\2:' \
		-e 's:\: \(.*\.\)\(c\|h\)$$:\: $(BldPath)/\1\2:' \
		> deps.mk

.PHONY: clean
clean:
	rm -fr $(PfxBldPath)
	rm -f $(ExeList)
	rm -f deps.mk

